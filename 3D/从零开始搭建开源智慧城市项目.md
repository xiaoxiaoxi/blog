# ä»é›¶å¼€å§‹æ­å»ºå¼€æºæ™ºæ…§åŸå¸‚é¡¹ç›®ï¼ˆä¸€ï¼‰åˆå§‹åŒ–åœºæ™¯

[![img](https://p9-passport.byteacctimg.com/img/user-avatar/5894006e106aef734beccc90facfcfe1~300x300.image)](https://juejin.cn/user/3703616627815518)

[Lixc ![lv-2](https://lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/f597b88d22ce5370bd94495780459040.svg)](https://juejin.cn/user/3703616627815518)

2021å¹´12æœˆ17æ—¥ 16:32 Â· é˜…è¯» 918

å…³æ³¨

## å‰è¨€

æœ¬ç¯‡æ–‡ç« æ˜¯ä»é›¶å¼€å§‹ä»¿å†™ä¸€ä¸ªæ™ºæ…§åŸå¸‚ç³»åˆ—æ–‡ç« çš„ç¬¬ä¸€ç¯‡ï¼Œè¿™ä¸€ç¯‡ä¸»è¦å®ç°ä¸€ä¸‹é¡¹ç›®çš„åˆå§‹åŒ–ï¼Œæ·»åŠ ä¸€ä¸‹`Three`åœºæ™¯çš„ä¸‰å¤§ç»„ä»¶ï¼šåœºæ™¯ï¼ˆ`scene`ï¼‰ã€ç›¸æœºï¼ˆ`camera`ï¼‰å’Œæ¸²æŸ“å™¨ï¼ˆ`renderer`ï¼‰ï¼ŒåŠ ä¸€ä¸ªæ§åˆ¶å™¨å¯ä»¥é€šå…³é¼ æ ‡æ§åˆ¶ç§»åŠ¨åœºæ™¯ï¼ŒæŠŠæ¨¡å‹æ•°æ®åŠ è½½åˆ°åœºæ™¯é‡Œé¢ã€‚

## åˆå§‹åŒ–é¡¹ç›®

åˆå§‹åŒ–é¡¹ç›® ç„¶ååˆ›å»ºä¸€ä¸ª`scens`çš„vueæ–‡ä»¶ åˆ›å»ºä¸€ä¸ª`div`

```javascript
<template>
  <div id="scene"></div>
</template>
å¤åˆ¶ä»£ç 
```

ç„¶åå¼•å…¥threeæ¨¡å— ,ç„¶åå¼•å…¥è¿™æ¬¡éœ€è¦çš„å‡ ä¸ªæ–‡ä»¶.

```javascript
import * as THREE from "three";//å¼•å…¥threeæ¨¡å—
import { OrbitControls } from "three/examples/jsm/controls/OrbitControls";//æ§åˆ¶å™¨æ¨¡å—
import { GLTFLoader } from "three/examples/jsm/loaders/GLTFLoader";//gltfæ¨¡å‹åŠ è½½æ¨¡å—
å¤åˆ¶ä»£ç 
```

## åˆå§‹åŒ–Threeä¸‰è¦ç´ 

1. åœºæ™¯ï¼š `three`ä¸­åˆ›å»ºåœºæ™¯åªéœ€è¦`new`ä¸€ä¸ª`THREE.Scene`å°±è¡Œäº†

```javascript
      scene = new THREE.Scene();
å¤åˆ¶ä»£ç 
```

1. ç›¸æœºï¼š ç›¸æœºåœ¨`three`ä¸­åˆ†æˆé€è§†ç›¸æœºå’Œæ­£æŠ•å½±ç›¸æœº è¿™é‡Œç”¨çš„æ˜¯é€è§†ç›¸æœº`PerspectiveCamera`

```javascript
      const width = window.innerWidth; // çª—å£å®½åº¦
      const height = window.innerHeight; // çª—å£é«˜åº¦
      /** é€è§†æŠ•å½±ç›¸æœºå¯¹è±¡ */
      camera = new THREE.PerspectiveCamera(60, width / height, 1, 100000);
      camera.position.set(6000, 9000, 6000); // æ ‘ä¸Šé¢è§‚å¯Ÿ
      // camera.position.set(200, 30, 200); //æ ‘ä¸‹é¢è§‚å¯Ÿ
      camera.lookAt(this.scene.position); // è®¾ç½®ç›¸æœºæ–¹å‘(æŒ‡å‘çš„åœºæ™¯å¯¹è±¡)
å¤åˆ¶ä»£ç 
```

1. æ¸²æŸ“å™¨ï¼š æ¸²æŸ“å™¨å†³å®šäº†æ¸²æŸ“çš„ç»“æœåº”è¯¥ç”»åœ¨å…ƒç´ çš„ä»€ä¹ˆå…ƒç´ ä¸Šé¢ï¼Œè¿™é‡Œé‡‡ç”¨çš„æ˜¯`WebGLRenderer`

```javascript
      const container = document.getElementById("scene");//æˆ–è€…Domå…ƒç´ ï¼Œå‰é¢éœ€è¦åˆ›å»ºä¸€ä¸ªidä¸ºsceneçš„divã€‚
      renderer = new THREE.WebGLRenderer({ alpha: true });//æ–°å»ºä¸€ä¸ªWebGLRenderer
      renderer.setSize(container.clientWidth, container.clientHeight); // è®¾ç½®æ¸²æŸ“åŒºåŸŸå°ºå¯¸
      container.appendChild(renderer.domElement); // bodyå…ƒç´ ä¸­æ’å…¥canvaså¯¹è±¡
å¤åˆ¶ä»£ç 
```

## åŠ è½½åœºæ™¯æ§åˆ¶å™¨å¹¶å¯¼å…¥æ¨¡å‹ï¼Œæ·»åŠ å…‰ç…§

1. æ¨¡å‹æ§åˆ¶å™¨ï¼š åªéœ€è¦åˆ›å»ºä¸€ä¸ª`OrbitControls`å¹¶ä¸”æŠŠç›¸æœºå’Œæ¸²æŸ“å™¨ä¸­ç»‘å®šçš„`Dom`å…ƒç´ ä¼ è¿›å»å°±è¡Œ

```javascript
      controls = new OrbitControls(camera, renderer.domElement);
å¤åˆ¶ä»£ç 
```

1. å¯¼å…¥æ¨¡å‹ï¼š å¯¼å…¥æ¨¡å‹éœ€è¦å®ä¾‹åŒ–ä¸€ä¸ª`GLTFLoader`,ç„¶åè°ƒç”¨`lod`æ–¹æ³•ï¼ŒæŠŠæ¨¡å‹åœ°å€åŠ è¿›å»ï¼Œç„¶åæŠŠæ•°æ®åŠ è½½åˆ°sceneä¸­ã€‚

```javascript
const loader = new GLTFLoader();
     loader.load("shanghai.gltf", (gltf) => {
       scene.add(gltf.scene);
     });
å¤åˆ¶ä»£ç 
      controls = new OrbitControls(camera, renderer.domElement);
å¤åˆ¶ä»£ç 
```

3.åŠ è½½å…‰ç…§ï¼š ç°åœ¨æ¨¡å‹å·²ç»èƒ½æ˜¾ç¤ºåœ¨åœºæ™¯é‡Œé¢äº†ä½†æ˜¯æ²¡æœ‰å…‰ç…§ ç°åœ¨éœ€è¦åŠ ä¸€ä¸‹å…‰ç…§

```javascript
       //åˆ›å»ºç‚¹å…‰æºå’Œç¯å¢ƒå…‰æº
        const point = new THREE.PointLight(0xffffff);
        point.position.set(6000, 9000, 6000); // ç‚¹å…‰æºä½ç½®
        scene.add(point); // ç‚¹å…‰æºæ·»åŠ åˆ°åœºæ™¯ä¸­
        // ç¯å¢ƒå…‰
        const ambient = new THREE.AmbientLight(0x888888);
        scene.add(ambient);
å¤åˆ¶ä»£ç 
```

æ•ˆæœå›¾

![SDGIF_Rusult_1.gif](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1fe424beb8044bdca336f648a2193775~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp?)

## ä¸Šå®Œæ•´ä»£ç 

```js
<template>
  <div id="scene"></div>
</template>
<script>
import * as THREE from "three";
import { OrbitControls } from "three/examples/jsm/controls/OrbitControls";
import { GLTFLoader } from "three/examples/jsm/loaders/GLTFLoader";
let scene; //åœºæ™¯
let camera; //ç›¸æœº
let renderer; //åˆ›å»ºæ¸²æŸ“å™¨
// eslint-disable-next-line no-unused-vars
let controls; //æ§åˆ¶å™¨
export default {
  mounted() {
    this.init();
    this.createControls();
    this.render();
      this.addGLTF();
  },
  methods: {
    init() {
      //åˆ›å»ºåœºæ™¯
      scene = new THREE.Scene();
      /**
       * é€è§†æŠ•å½±ç›¸æœºè®¾ç½®
       */
      const width = window.innerWidth; // çª—å£å®½åº¦
      const height = window.innerHeight; // çª—å£é«˜åº¦

      /** é€è§†æŠ•å½±ç›¸æœºå¯¹è±¡ */
      camera = new THREE.PerspectiveCamera(60, width / height, 1, 100000);
      camera.position.set(6000, 9000, 6000); // æ ‘ä¸Šé¢è§‚å¯Ÿ
      camera.lookAt(scene.position); // è®¾ç½®ç›¸æœºæ–¹å‘(æŒ‡å‘çš„åœºæ™¯å¯¹è±¡)
      // åˆ›å»ºæ¸²æŸ“å™¨å¯¹è±¡
      const container = document.getElementById("scene");
      renderer = new THREE.WebGLRenderer({ alpha: true });
      renderer.setSize(container.clientWidth, container.clientHeight); // è®¾ç½®æ¸²æŸ“åŒºåŸŸå°ºå¯¸
      container.appendChild(renderer.domElement); // bodyå…ƒç´ ä¸­æ’å…¥canvaså¯¹è±¡

        //åˆ›å»ºç‚¹å…‰æºå’Œç¯å¢ƒå…‰æº
        const point = new THREE.PointLight(0xffffff);
        point.position.set(6000, 9000, 6000); // ç‚¹å…‰æºä½ç½®
        scene.add(point); // ç‚¹å…‰æºæ·»åŠ åˆ°åœºæ™¯ä¸­
        // ç¯å¢ƒå…‰
        const ambient = new THREE.AmbientLight(0x888888);
        scene.add(ambient);
    },
    createControls() {
      controls = new OrbitControls(camera, renderer.domElement);
    },
    render() {
      renderer.render(scene, camera);
      requestAnimationFrame(this.render); // è¯·æ±‚å†æ¬¡æ‰§è¡Œæ¸²æŸ“å‡½æ•°render
    },
    addGLTF() {
      const loader = new GLTFLoader();
      loader.load("shanghai.gltf", (gltf) => {
        scene.add(gltf.scene);
      });
    },
  },
};
</script>
<style scoped>
html,
body,
#scene {
  width: 100%;
  height: 100vh;
  z-index: 2;
  position: absolute;
  top: 0%;
}
</style>

å¤åˆ¶ä»£ç 
```

é¡¹ç›®åœ°å€ï¼š[github.com/lixiaochjajâ€¦](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Flixiaochjajo%2FSmartCity-Three)

## æœ€å

è¿™æ˜¯ç¬¬ä¸€ç¯‡åˆ›å»ºåœºæ™¯ï¼Œæ¥ä¸‹å‡ ç¯‡æˆ‘ä¼šä»‹ç»æ·»åŠ è‡ªå®šä¹‰æè´¨ï¼Œåå¤„ç†å®ç°æ¨¡å‹æè´¨æ›¿æ¢ï¼Œè¾‰å…‰æ•ˆæœï¼ŒæµåŠ¨çº¿ï¼Œæ‰«æçº¿ï¼Œæ‰©æ•£æ•ˆæœç­‰ä½¿å…¶çœ‹èµ·æ¥ç‚«é…·ä¸€äº›ï¼Œå¹¶äº‰å–é€šè¿‡å¤šç§æ–¹å¼å®ç°ä»¥ä¸Šæ•ˆæœï¼Œæ·»åŠ å¤©ç©ºç›’å¹¶è§£å†³å¤©ç©ºç›’å’Œåå¤„ç†å†²çªé—®é¢˜ï¼Œè¿˜æœ‰ä»€ä¹ˆæ¯”è¾ƒç‚«é…·çš„æ•ˆæœæ¬¢è¿å¤§å®¶ææ„è§ã€‚



# ä»é›¶å¼€å§‹æ­å»ºå¼€æºæ™ºæ…§åŸå¸‚é¡¹ç›®ï¼ˆäºŒï¼‰æ¨¡å‹çº¿æ¡†å’Œç‰©ç†æè´¨

[![img](https://p9-passport.byteacctimg.com/img/user-avatar/5894006e106aef734beccc90facfcfe1~300x300.image)](https://juejin.cn/user/3703616627815518)

[Lixc ![lv-2](https://lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/f597b88d22ce5370bd94495780459040.svg)](https://juejin.cn/user/3703616627815518)

2021å¹´12æœˆ18æ—¥ 18:53 Â· é˜…è¯» 399

å…³æ³¨

## å‰è¨€

ä¸Šä¸€ç« å·²ç»é€šè¿‡`GLTFLoader`æŠŠæ¨¡å‹æ•°æ®åŠ è½½åˆ°åœºæ™¯ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¯¹è¿™äº›æ•°æ®è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ã€‚é¦–å…ˆæ˜¯æŠŠæ¨¡å‹åˆ†ç±»ï¼Œæ•´ä¸ªæ¨¡å‹å¯ä»¥åˆ†ä¸ºä¸‰ç±»ï¼Œå»ºç­‘ï¼ˆ`CITY_UNTRIANGULATED`ï¼‰ï¼Œé“è·¯ï¼ˆ`ROADS`ï¼‰ï¼Œåœ°é¢ï¼ˆ`other`ï¼‰,å¯¹ä¸åŒçš„æ•°æ®åˆ†åˆ«æ·»åŠ ä¸åŒçš„æè´¨ã€‚

## æ¨¡å‹çš„çº¿æ¡†æ·»åŠ 

æ¨¡å‹æè´¨åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†æ˜¯æ¨¡å‹çš„çº¿æ¡†æè´¨ï¼Œç¬¬äºŒéƒ¨åˆ†æ˜¯æ¨¡å‹çš„é¢æè´¨ï¼Œé¦–å…ˆæ¥è¯´çº¿æ¡†æè´¨

1. çº¿æ¡†æè´¨ï¼šé€šè¿‡`Three`çš„`EdgesGeometry`å¯ä»¥æŠŠç”Ÿæˆæ¨¡å‹çš„çº¿æ¡†æ•°æ®ï¼Œç”¨LineBasicMaterialç”Ÿæˆçº¿æ¡†çš„æ¨¡å‹æè´¨ï¼Œç„¶åç”¨`LineSegments`æŠŠè¿™ä¸¤ä¸ªæ•°æ®ç»„åˆåˆ°ä¸€èµ·ï¼Œå³å¯ç”Ÿäº§çº¿æ¡†æ¨¡å‹å¯¹è±¡ã€‚

```javascript
              // æ‹¿åˆ°æ¨¡å‹çº¿æ¡†çš„Geometry,å…¶ä¸­child.geometryæ˜¯æ¨¡å‹å­å¯¹è±¡çš„èŠ‚ç‚¹æ•°æ®
              const edges = new THREE.EdgesGeometry(child.geometry, 1);
              //è®¾ç½®æ¨¡å‹çš„æè´¨
              const lineMaterial = new THREE.LineBasicMaterial({
                // çº¿çš„é¢œè‰²
                color: "rgba(38,133,254)",
              });
              //æŠŠæ•°æ®ç»„åˆèµ·æ¥
              const lineS = new THREE.LineSegments(edges, lineMaterial);
              //è®¾ç½®æ•°æ®çš„ä½ç½®
              lineS.position.set(
                child.position.x,
                child.position.y,
                child.position.z
              );
              //æ·»åŠ åˆ°åœºæ™¯
              scene.add(lineS);
å¤åˆ¶ä»£ç 
```

æ•ˆæœå›¾: ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/00ba1b98af4c4441bcb161240d6dea2c~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp?) 2. æ¨¡å‹é¢æè´¨ï¼šè¿™é‡Œæ¨¡å‹é¢æè´¨é€‰æ‹©çš„æ˜¯`Three`çš„ç‰©ç†æè´¨`MeshPhysicalMaterial`ç±»ï¼Œè¿™ä¸ªç±»å¯ä»¥æ¨¡æ‹Ÿç»ç’ƒçš„è´¨æ„Ÿ.

```javascript
              // æ¨¡å‹é¢æè´¨
             const material = new THREE.MeshPhysicalMaterial({
                //é¢œè‰²ä¸º
                color: "rgb(50,170,255)",
                //é‡‘å±åº¦
                metalness: 0.5,
                //ç²—ç³™åº¦
                roughness: 0.1,
                //é€æ˜åº¦
                transmission: 0.9,
                //æ¨¡å‹æ˜¯å¦é€æ˜
                transparent: true,
              });
              //ç”Ÿæˆæ¨¡å‹å¯¹è±¡
              const mesh = new THREE.Mesh(child.geometry, material);
              //æ·»åŠ åˆ°åœºæ™¯
              scene.add(mesh);
å¤åˆ¶ä»£ç 
```

æ•ˆæœå›¾ï¼š

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/83bc289926e9404eae86950a912f4694~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp?)

## åœ°é¢å’Œé“è·¯æè´¨è®¾ç½®

é“è·¯å’Œåœ°é¢é€‰æ‹©çš„æ˜¯åŸºæœ¬æè´¨ç±»`MeshBasicMaterial`

```javascript
             //é“è·¯
              const material = new THREE.MeshBasicMaterial({
                color: "rgb(41,46,76)",
              });
              const mesh = new THREE.Mesh(child.geometry, material);
              scene.add(mesh);
              //åœ°é¢
              const material = new THREE.MeshBasicMaterial({
                color: "#040912",
              });
              const mesh = new THREE.Mesh(child.geometry, material);
              scene.add(mesh);

å¤åˆ¶ä»£ç 
```

æ•ˆæœå›¾ï¼š ![GIF 2021-12-18 18-10-30.gif](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/55c0ab5452f34965b8a8d5fbec3c0fa4~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp?)

## å®Œæ•´ä»£ç 

```javascript
 addGLTF() {
      const loader = new GLTFLoader();
      loader.load("shanghai.gltf", (gltf) => {
        gltf.scene.traverse((child) => {
          // è®¾ç½®çº¿æ¡†æè´¨

          if (child.isMesh) {
            //è¿™ä¸ªåˆ¤æ–­æ¨¡å‹æ˜¯æ¥¼æˆ¿è¿˜æ˜¯å…¶ä»–  åŠ è½½ä¸åŒçš„æè´¨
            if (["CITY_UNTRIANGULATED"].includes(child.name)) {
              // æ‹¿åˆ°æ¨¡å‹çº¿æ¡†çš„Geometry
              const edges = new THREE.EdgesGeometry(child.geometry, 1);
              //è®¾ç½®æ¨¡å‹çš„æè´¨
              const lineMaterial = new THREE.LineBasicMaterial({
                // çº¿çš„é¢œè‰²
                color: "rgba(38,133,254)",
              });
              //æŠŠæ•°æ®ç»„åˆèµ·æ¥
              const lineS = new THREE.LineSegments(edges, lineMaterial);
              //è®¾ç½®æ•°æ®çš„ä½ç½®
              lineS.position.set(
                child.position.x,
                child.position.y,
                child.position.z
              );
              //æ·»åŠ åˆ°åœºæ™¯
              scene.add(lineS);
              lineS.rotateX(-Math.PI / 2);
              // æ¨¡å‹é¢æè´¨
              const material = new THREE.MeshPhysicalMaterial({
                //é¢œè‰²ä¸º
                color: "rgb(50,170,255)",
                //é‡‘å±åº¦
                metalness: 0.5,
                //ç²—ç³™åº¦
                roughness: 0.1,
                //é€æ˜åº¦
                transmission: 0.9,
                //æ¨¡å‹æ˜¯å¦é€æ˜
                transparent: true,
              });
              //ç”Ÿæˆæ¨¡å‹å¯¹è±¡
              const mesh = new THREE.Mesh(child.geometry, material);
              //æ·»åŠ åˆ°åœºæ™¯
              scene.add(mesh);
              mesh.position.set(
                child.position.x,
                child.position.y,
                child.position.z
              );

              mesh.rotateX(-Math.PI / 2);
            } else if (["ROADS"].includes(child.name)) {
              //é“è·¯
              const material = new THREE.MeshBasicMaterial({
                color: "rgb(41,46,76)",
           
              });
              const mesh = new THREE.Mesh(child.geometry, material);
              mesh.rotateX(-Math.PI / 2);
              mesh.position.set(
                child.position.x,
                child.position.y,
                child.position.z
              );
              scene.add(mesh);
            } else {
              //åœ°é¢
              const material = new THREE.MeshBasicMaterial({
                color: "#040912",
              });
              const mesh = new THREE.Mesh(child.geometry, material);
              scene.add(mesh);
              mesh.rotateX(-Math.PI / 2);
              mesh.position.set(
                child.position.x,
                child.position.y,
                child.position.z
              );
          
            }
          }
          // è®¾ç½®çº¿æ¡†æè´¨
        });
      });
    },
å¤åˆ¶ä»£ç 
```

é¡¹ç›®åœ°å€: [github.com/lixiaochjajâ€¦](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Flixiaochjajo%2FSmartCity-Three)

# ä»é›¶å¼€å§‹æ­å»ºå¼€æºæ™ºæ…§åŸå¸‚é¡¹ç›®ï¼ˆä¸‰ï¼‰ä¸Šå‡çº¿æ•ˆæœ

[![img](https://p9-passport.byteacctimg.com/img/user-avatar/5894006e106aef734beccc90facfcfe1~300x300.image)](https://juejin.cn/user/3703616627815518)

[Lixc ![lv-2](https://lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/f597b88d22ce5370bd94495780459040.svg)](https://juejin.cn/user/3703616627815518)

2021å¹´12æœˆ20æ—¥ 17:18 Â· é˜…è¯» 543

å…³æ³¨

## å‰è¨€

ä¸Šä¸€èŠ‚å®ç°äº†æ·»åŠ å»ºç­‘ç‰©çº¿æ¡†ï¼Œæ¨¡å‹å¤–å¢™å’Œé“è·¯åœ°é¢æè´¨æ·»åŠ ã€‚è¿™ä¸€èŠ‚å‡†å¤‡é€šè¿‡ç®€å•çš„`shader`å®ç°ä¸Šå‡çº¿æ•ˆæœã€‚

## æ€è·¯

ç®€å•çš„è¯´ä¸€ä¸‹æ€è·¯ï¼Œé€šè¿‡è·å–æ¨¡å‹é¡¶ç‚¹åæ ‡æ‰€åœ¨çš„é«˜åº¦Zæ¥è¿›è¡Œç­›é€‰ï¼Œé«˜åº¦å†æŸä¸€åŒºé—´å†…è®¾ç½®æˆä¸Šå‡çº¿çš„é¢œè‰²ï¼Œå…¶ä½™é«˜åº¦é¢œè‰²æ­£å¸¸ï¼ŒæŠŠé«˜åº¦ä¸æ–­ä¸Šå‡æ¥è®©è¿™æ ¹ä¸Šå‡çº¿ä¸æ–­ä¸Šå‡ï¼Œåˆ°ä¸€å®šé«˜åº¦åé‡ç½®ã€‚

## ShaderMaterialçš„ç»„æˆ

å®ç°ä¸»è¦é€šå…³`Three`å†…è‡ªå®šä¹‰æè´¨(`ShaderMaterial`)æ¥å®ç°,é¦–å…ˆæ¥å®ç°ä¸€ä¸ªæœ€ç®€å•çš„`ShaderMaterial`æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæè´¨çš„ç»„æˆã€‚

```javascript
  const shader = new THREE.ShaderMaterial({
      //ä»ç¨‹åºç©¿åˆ°ç€è‰²å™¨é‡Œé¢çš„å€¼ï¼Œè¿™é‡Œå…ˆä¸ä¼ å€¼
        uniforms: {
        },
        //é¡¶ç‚¹ç€è‰²å™¨
         vertexShader: `
                void main()
                {
                  gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
                }`,
         //ç‰‡æ®µç€è‰²å™¨
         fragmentShader: `
                  void main()
                  {
                    gl_FragColor = vec4(1.0);
                  }`,
      });
å¤åˆ¶ä»£ç 
```

1. é¡¶ç‚¹ç€è‰²å™¨ï¼ˆ`vertexShader `ï¼‰ï¼šé¦–å…ˆæ¥ä»‹ç»ä¸€ä¸‹é¡¶ç‚¹ç€è‰²å™¨ï¼Œé¡¶ç‚¹ç€è‰²å™¨æ˜¯ç”¨æ¥å¤„ç†é¡¶ç‚¹æ•°æ®çš„ï¼Œæœ¬ä¾‹å­ä¸­çš„é¡¶ç‚¹ç€è‰²å™¨ä¸»è¦ä»£ç å°±ä¸€å¥ï¼š

```javascript
 gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
å¤åˆ¶ä»£ç 
```

å…ˆæ¥è¯´ä¸€ä¸‹æ¯ä¸ªå˜é‡çš„æ„æ€

- positionï¼šæ¨¡å‹ç‚¹ä½æ•°æ®ã€‚
- modelViewMatrixï¼šè§†å›¾çŸ©é˜µï¼Œç­‰äºcamera.matrixWorldInverse * object.matrixWorldï¼Œå°±æ˜¯æ¨¡å‹çŸ©é˜µå’Œç›¸æœºçŸ©é˜µï¼ˆè§†å›¾çŸ©é˜µï¼‰çš„ä¹˜ç§¯ã€‚
- projectionMatrixï¼šæŠ•å½±çŸ©é˜µï¼Œç­‰äºcamera.projectionMatrixã€‚
- gl_Positionï¼šçŸ©é˜µå˜æ¢åæ¨¡å‹ç‚¹ä½æŠ•å½±åˆ°å±å¹•ä¸Šçš„ä½ç½®ï¼Œè¯¥å€¼ä¸positionçš„å…³ç³»å¦‚ä¸‹å›¾ã€‚

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6757d1dec7204692b1aa25d403fbb7f0~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp?)

ç»è¿‡ä¸Šè¿°çš„çŸ©é˜µå˜åŒ–ï¼Œæ¨¡å‹å°±ä¼šæŠ•å½±åˆ°è£å‰ªåæ ‡ç³»ç„¶åç»è¿‡ä¸€ç³»åˆ—è®¡ç®—ï¼Œæ˜¾ç¤ºåˆ°å±å¹•ä¸Šã€‚

1. ç‰‡æ®µç€è‰²å™¨ ï¼ˆ`fragmentShader `ï¼‰ï¼šç‰‡æ®µç€è‰²å™¨æ˜¯ç‰‡å…ƒçš„é¢œè‰²,æœ¬ä¾‹å­ä¸­çš„é¡¶ç‚¹ç€è‰²å™¨å¦‚ä¸‹ï¼š

```javascript
 gl_FragColor = vec4(1.0ï¼Œ1.0ï¼Œ1.0ï¼Œ1.0);
å¤åˆ¶ä»£ç 
```

gl_FragColoræ˜¯æ¯ä¸ªç‰‡æ®µçš„é¢œè‰²ï¼Œè¿™é‡Œç»Ÿä¸€è®¾ç½®æˆç™½è‰²` vec4(1.0ï¼Œ1.0ï¼Œ1.0ï¼Œ1.0)`ã€‚ ç„¶åæŠŠè¿™ä¸ªæè´¨èµ‹ç»™æ¨¡å‹

```javascript
//object.geometryæ˜¯æ¨¡å‹çš„geometryå±æ€§ï¼Œshaderæ˜¯ä¸Šé¢å®šä¹‰çš„æè´¨
  const city = new THREE.Mesh(object.geometry, shader);
//æŠŠé‡æ–°ç”Ÿæˆçš„æ¨¡å‹å¯¹è±¡æ·»åŠ åˆ°åœºæ™¯é‡Œé¢
  scene.add(city);
å¤åˆ¶ä»£ç 
```

è¿™é‡Œçš„æ˜¾ç¤ºæ•ˆæœï¼š

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3fc92c07563e461da3eaf5a2728339b9~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp?)

æ‰€æœ‰çš„å»ºç­‘æ¨¡å‹æ˜¾ç¤ºç™½è‰²ã€‚

## ä¸Šå‡çº¿æ•ˆæœå®ç°

1. è¿™ä¸ªæ•ˆæœçš„å®ç°éœ€è¦å››ä¸ªå€¼ï¼šçº¿ä¸Šå‡åˆ°çš„é«˜åº¦`height`ã€ä¸Šå‡çº¿çš„é¢œè‰²`uFlowColor`ã€å»ºç­‘æ¨¡å‹çš„é¢œè‰²`uCityColor`ã€æ¨¡å‹ç‚¹ä½çš„é«˜åº¦å€¼zï¼ˆè¿™ä¸ªé¡¶ç‚¹ç€è‰²å™¨é‡Œé¢æœ‰ï¼Œéœ€è¦ä»é¡¶ç‚¹ç€è‰²å™¨ä¼ åˆ°ç‰‡æ®µç€è‰²å™¨ä¸­ï¼‰ï¼Œç„¶åæŠŠè¿™äº›å€¼é€šè¿‡`uniforms`ä¼ å…¥åˆ°ç€è‰²å™¨é‡Œé¢å»ã€‚ç€è‰²å™¨ä»£ç å¦‚ä¸‹ï¼š

```javascript
   const shader = new THREE.ShaderMaterial({
        uniforms: {
          height: this.height,
         uFlowColor: {
            value: new THREE.Color("#5588aa"),
          },
          uCityColor: {
            value: new THREE.Color("#FFFFDC"),
          },
        },
        vertexShader: `
                varying vec3 vPosition;
                void main()
                {
                  vPosition = position;
                  gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
                }`,
        fragmentShader: `
                  varying vec3 vPosition;
                    uniform float height;
                     uniform float uStartTime; 
                    uniform vec3 uSize;
                    uniform vec3 uFlow;
                    uniform vec3 uFlowColor;
                    uniform vec3 uCityColor;
                  void main()
                  {
                    //æ¨¡å‹çš„åŸºç¡€é¢œè‰²
                   vec3 distColor=uCityColor;
                 // æµåŠ¨èŒƒå›´å½“å‰ç‚¹zçš„é«˜åº¦åŠ ä¸ŠæµåŠ¨çº¿çš„é«˜åº¦
                   float topY = vPosition.z +5.0;
                if (height > vPosition.z && height < topY) {
                   // é¢œè‰²æ¸å˜ 
                    distColor = uFlowColor; 
                  }
                   gl_FragColor = vec4(distColor, 0.6);
                  }`,
                    transparent: true,
      });
å¤åˆ¶ä»£ç 
```

renderæ·»åŠ å¦‚ä¸‹ä»£ç 

```javascript
      this.height.value += 0.03;
      if(this.height.value>100)
      {
        this.height.value=0.0
      }
å¤åˆ¶ä»£ç 
```

é¦–å…ˆè¯´ä¸€ä¸‹renderä¸­çš„ä»£ç ï¼Œrenderæ˜¯åœ¨æ¯ä¸€æ¬¡æ¸²æŸ“ä¸­éƒ½ä¼šæ‰§è¡Œï¼Œåœ¨æ¯ä¸€å¸§æ¸²æŸ“æ—¶æŠŠheightå€¼é€æ¸å¢åŠ ï¼Œå½“heightå¤§äº100çš„æ—¶å€™é‡ç½®ã€‚

æ¥ä¸‹æ¥æ˜¯shaderæè´¨çš„å®šä¹‰ï¼Œè¿™é‡Œæˆ‘ä»¬åœ¨uniformsä¸­æŠŠéœ€è¦çš„ä¸Šå‡çº¿çš„é«˜åº¦`height`,ä¸Šå‡çº¿çš„é¢œè‰²`uFlowColor`ï¼Œå»ºç­‘æ¨¡å‹çš„é¢œè‰²`uCityColor`è¿›è¡Œäº†ä¼ å…¥ï¼Œç„¶ååœ¨`vertexShader`ä¸­æŠŠ`fragmentShader`éœ€è¦çš„ç‚¹ä½å±`vPosition`æ€§é€šè¿‡`varying`å˜é‡å®ç°äº†ä¸¤ä¸ªç€è‰²å™¨ç›´æ¥çš„å…±ç”¨ï¼Œè¿™æ ·ä¸Šå‡æ•ˆæœéœ€è¦çš„å˜é‡å°±éƒ½é½å…¨äº†ã€‚

åœ¨ç‰‡æ®µç€è‰²å™¨ä¸­é¦–å…ˆå®šä¹‰æ¨¡å‹çš„åŸºæœ¬é¢œè‰²`distColor`ï¼Œç„¶åå®šä¹‰æµåŠ¨é¢œè‰²çš„ä½ç½®`float topY = vPosition.z +5.0`;`vPosition.z` æ˜¯å½“å‰ç‚¹ä½çš„zå€¼åŠ ä¸Šä¸€ä¸ªå®½åº¦å°±æ˜¯æ¨¡å‹éœ€è¦ç€è‰²çš„éƒ¨ä½ã€‚ä¸‹ä¸€æ­¥è¿›è¡Œç­›é€‰ï¼Œç­›é€‰ç‚¹ä½é«˜åº¦åœ¨ `vPosition.z-height`å’Œ` vPosition.z+0.5-height`ä¹‹é—´çš„å€¼è¿›è¡Œç€è‰²ã€‚æŠŠè¿™ä¸€å—çš„é¢œè‰²è®¾ç½®æˆä¸Šå‡ç‰‡æ®µçš„é¢œè‰²ï¼ˆ`uFlowColor`ï¼‰.æ˜¾ç¤ºæ•ˆæœå¦‚ä¸‹å›¾ï¼š

![SDGIF_Rusult_1.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e1a16e2c588740cdb77d55b6d2df39a2~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp?)

é¡¹ç›®åœ°å€: [github.com/lixiaochjajâ€¦](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Flixiaochjajo%2FSmartCity-Three)



# ä»é›¶å¼€å§‹æ­å»ºå¼€æºæ™ºæ…§åŸå¸‚é¡¹ç›®ï¼ˆå››ï¼‰æ‰©æ•£æ‰«å…‰å’Œé¢œè‰²æ¸å˜

[![img](https://p9-passport.byteacctimg.com/img/user-avatar/5894006e106aef734beccc90facfcfe1~300x300.image)](https://juejin.cn/user/3703616627815518)

[Lixc ![lv-2](https://lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/f597b88d22ce5370bd94495780459040.svg)](https://juejin.cn/user/3703616627815518)

2021å¹´12æœˆ21æ—¥ 15:57 Â· é˜…è¯» 258

å…³æ³¨

## å‰è¨€

ä¸Šä¸€èŠ‚å®ç°äº†ä¸Šå‡çº¿æ•ˆæœï¼Œè¿™ä¸€èŠ‚ç»§ç»­ä¿®æ”¹ä¸Šä¸€èŠ‚ä¸­çš„`shader`ï¼Œæ·»åŠ é¢œè‰²æ¸å˜æ•ˆæœå’Œæ‰©æ•£æ‰«å…‰æ•ˆæœã€‚

## æ€è·¯

é¢œè‰²æ¸å˜ï¼šè®©æ‰©æ•£æ‰«å…‰çš„æ•ˆæœä¸­é—´äº®ï¼Œä¸¤è¾¹æš—ï¼Œæ¥æ¨¡æ‹Ÿå…‰çš„æ•ˆæœï¼Œå¯é€šè¿‡`sin`å‡½æ•°æ¨¡æ‹Ÿæ•ˆæœï¼ŒæŠŠæ‰«å…‰åŠå¾„è®¡ç®—åˆ°0-PIä¹‹é—´ã€‚ä»–ä»¬çš„å€¼å˜åŒ–å¦‚ä¸‹å›¾ï¼Œ`0`ï¼Œ`PI`æœ€æš—ï¼Œ`PI/2`æœ€äº®ã€‚

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b3283ae469d94fdb97c8122d974e1b02~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp?)

æ‰©æ•£æ‰«å…‰ï¼šè¿™ä¸ªæ€è·¯ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œè®¾ç½®ä¸€ä¸ªåŸç‚¹ï¼Œç„¶åç¬¬ä¸€å¸§æ¨¡å‹è·ç¦»è¿™ä¸ªåŸç‚¹`0-10`å•ä½é•¿åº¦çš„æ‰€æœ‰çš„ç‚¹è¿›è¡Œå‘å…‰ï¼Œç¬¬äºŒå¸§è·ç¦»`10-20`å•ä½é•¿åº¦çš„ç‚¹è¿›è¡Œå‘å…‰ï¼Œä»¥æ­¤ç±»æ¨ã€‚

## ä»£ç è®²è§£

```javascript
   fragmentShader: `
   //æ±‚è·ç¦»çš„å…¬å¼ï¼Œå¹³æ–¹å’Œå¼€æ ¹å·
float distanceTo(vec2 src,vec2 dst)
{
    float dx=src.x-dst.x;
    float dy=src.y-dst.y;
    float dv=dx*dx+dy*dy;
    return sqrt(dv);
}
varying vec3 vPosition;
uniform float height;
uniform vec3 uFlowColor;
uniform vec3 uCityColor;
void main()
{
    //æ¨¡å‹çš„åŸºç¡€é¢œè‰²
    vec3 distColor=uCityColor;
    //å®šä½å½“å‰ç‚¹ä½ä½ç½®
    vec2 position2D=vec2(vPosition.x,vPosition.y);
    //æ±‚ç‚¹åˆ°åŸç‚¹çš„è·ç¦»
    float Len=distanceTo(position2D,vec2(0,0));
      if(Len>height*30.0&&Len<(height*30.0+130.0)){
        // é¢œè‰²æ¸å˜
        float dIndex = sin((Len - height*30.0) / 130.0 * 3.14);
        //é€šè¿‡ä¸Šé¢çš„æ¸å˜å€¼è¿›è¡Œé¢œè‰²æ··åˆ
        distColor= mix(uFlowColor, distColor, 1.0-dIndex);
    }
    //æœ€ç»ˆé¢œè‰²
    gl_FragColor=vec4(distColor,1.0);
}`,
å¤åˆ¶ä»£ç 
```

ä¼ å…¥çš„å€¼å’Œä¸Šä¸€èŠ‚ç›¸æ¯”æ²¡æœ‰å˜åŒ–ï¼Œä¸»å‡½æ•°éƒ¨åˆ†å…³äºä¸Šå‡çº¿æ•ˆæœçš„ä¹Ÿä¸è¿›è¡Œä»‹ç»äº†ï¼Œæƒ³è¦äº†è§£å¯ä»¥çœ‹ä¸Šä¸€ç¯‡æ–‡ç« ï¼ˆ[juejin.cn/post/704371â€¦](https://juejin.cn/post/7043711598174666783)) ä¸‹é¢è¯´ä¸€ä¸‹æ·»åŠ çš„éƒ¨åˆ†ã€‚

- å‡½æ•°æ–°æ·»åŠ äº†ä¸€ä¸ªè®¡ç®—ä¸¤ç‚¹ï¼ˆå¹³é¢ç‚¹ï¼‰è·ç¦»çš„å‡½æ•°`distanceTo`ï¼Œé€šè¿‡å‹¾è‚¡å®šç†è®¡ç®—ä¸¤ä¸ªç‚¹çš„è·ç¦»ã€‚
- `vec2 position2D=vec2(vPosition.x,vPosition.y);`æ˜¯æŠŠä»é¡¶ç‚¹ç€è‰²å™¨ä¸­çš„ç‚¹çš„`x`,`y`åæ ‡è¿›è¡Œç»„åˆï¼Œé‡æ–°ç”Ÿæˆäº†ä¸€ä¸ªå¹³é¢åæ ‡ã€‚
- `float Len=distanceTo(position2D,vec2(0,0))`æ˜¯è®¡ç®—æ¨¡å‹ç‚¹å¹³é¢åæ ‡åˆ°åŸç‚¹çš„è·ç¦»ï¼Œç„¶åæŠŠè·ç¦»åœ¨`height*30.0`å’Œ`height*30.0+130.0`ä¹‹é—´çš„ç‚¹è¿›è¡Œæ··è‰²ã€‚å…¶ä¸­`height*30`æ˜¯åŸç‚¹è·å‘å…‰ç¯å†…åŠå¾„çš„è·ç¦»ï¼Œ`height*30+130`æ˜¯åŸç‚¹è·å‘å…‰ç¯å¤–åŠå¾„çš„è·ç¦»ï¼Œ`130.0`æ˜¯å‘å…‰ç¯çš„å†…å¾„ã€‚
- `float dIndex = sin((Len - height*30.0) / 130.0 * 3.14)`æ˜¯é€šè¿‡`sin`å‡½æ•°æŠŠè·ç¦»åœ¨`height*30.0`åˆ°`height*30.0+130.0`ä¹‹é—´çš„å€¼è¿›è¡Œè®¡ç®—ï¼Œå€¼ä»`height*30.0`åˆ°`height*30.0+65.0`åˆ°`height*30.0+130.0`åˆ†åˆ«æ˜¯`0.0â€”â€”1.0â€”â€”0.0`ï¼Œå®ç°ä¸¤è¾¹å€¼å°ä¸­é—´å€¼å¤§çš„æ•ˆæœã€‚
- `distColor= mix(uFlowColor, distColor, 1.0-dIndex)`æ˜¯é€šè¿‡mixå‡½æ•°è¿›è¡Œé¢œè‰²æ··è‰²ï¼ŒæŠŠ`uFlowColor`å’Œ

`distColor`ä¸¤ä¸ªé¢œè‰²é€šè¿‡`1.0ï¼š 1.0-dIndex`è¿›è¡Œæ··è‰².å®ç°æœ€ç»ˆæ•ˆæœã€‚

## å®Œæ•´ä»£ç 

```javascript
 setCityMaterial(object) {
      const shader = new THREE.ShaderMaterial({
        uniforms: {
          height: this.height,
          uFlowColor: {
            value: new THREE.Color("#5588aa"),
          },
          uCityColor: {
            value: new THREE.Color("#1B3045"),
          },
        },
        vertexShader: `
                varying vec3 vPosition;
                void main()
                {
                  vPosition = position;
                  gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
                }`,
        fragmentShader: `
float distanceTo(vec2 src,vec2 dst)
{
    float dx=src.x-dst.x;
    float dy=src.y-dst.y;
    float dv=dx*dx+dy*dy;
    return sqrt(dv);
}
varying vec3 vPosition;
uniform float height;
uniform float uStartTime;
uniform vec3 uSize;
uniform vec3 uFlowColor;
uniform vec3 uCityColor;
void main()
{
    //æ¨¡å‹çš„åŸºç¡€é¢œè‰²
    vec3 distColor=uCityColor;
    // æµåŠ¨èŒƒå›´å½“å‰ç‚¹zçš„é«˜åº¦åŠ ä¸ŠæµåŠ¨çº¿çš„é«˜åº¦
    float topY=vPosition.z+10.;
    if(height>vPosition.z&&height<topY){
        // é¢œè‰²æ¸å˜
            float dIndex = sin((height - vPosition.z) / 10.0 * 3.14);
            distColor = mix(uFlowColor, distColor, 1.0-dIndex);

    }
    //å®šä½å½“å‰ç‚¹ä½ä½ç½®
    vec2 position2D=vec2(vPosition.x,vPosition.y);
    //æ±‚ç‚¹åˆ°åŸç‚¹çš„è·ç¦»
    float Len=distanceTo(position2D,vec2(0,0));
      if(Len>height*30.0&&Len<(height*30.0+130.0)){
        // é¢œè‰²æ¸å˜
        float dIndex = sin((Len - height*30.0) / 130.0 * 3.14);
        distColor= mix(uFlowColor, distColor, 1.0-dIndex);
    }
    gl_FragColor=vec4(distColor,1.0);
}`,
                    transparent: true,
      });

      const city = new THREE.Mesh(object.geometry, shader);
      city.position.set(
        object.position.x,
        object.position.y,
        object.position.z
      );
      scene.add(city);
      city.rotateX(-Math.PI / 2);
    },
å¤åˆ¶ä»£ç 
```

## æ•ˆæœå›¾

![SDGIF_Rusult_1.gif](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/01cfb1a9ee364a6b8b110fe78ae63f0d~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp?) é¡¹ç›®åœ°å€: [github.com/lixiaochjajâ€¦](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Flixiaochjajo%2FSmartCity-Three)

# ä»é›¶å¼€å§‹æ­å»ºå¼€æºæ™ºæ…§åŸå¸‚é¡¹ç›®ï¼ˆäº”ï¼‰èƒŒæ™¯å¤©ç©ºç›’ã€æ‰©æ•£å¢™ã€æ‰©æ•£åœ†

[![img](https://p9-passport.byteacctimg.com/img/user-avatar/5894006e106aef734beccc90facfcfe1~300x300.image)](https://juejin.cn/user/3703616627815518)

[Lixc ![lv-2](https://lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/f597b88d22ce5370bd94495780459040.svg)](https://juejin.cn/user/3703616627815518)

2021å¹´12æœˆ23æ—¥ 15:25 Â· é˜…è¯» 1033

å…³æ³¨

## å‰è¨€

ä¸Šä¸€èŠ‚å®ç°äº†é¢œè‰²æ¸å˜æ•ˆæœå’Œæ‰©æ•£æ‰«å…‰æ•ˆæœï¼Œè¿™ä¸€èŠ‚æ¥æ·»åŠ èƒŒæ™¯å¤©ç©ºç›’ã€æ‰©æ•£å¢™ã€æ‰©æ•£åœ†ã€‚

## æ·»åŠ å¤©ç©ºç›’æ€è·¯

`three`æ·»åŠ å¤©ç©ºç›’æœ‰ä¸¤ç§æ ¼å¼ï¼Œä¸€ç§æ˜¯éœ€è¦ä¸Šä¸‹å·¦å³å‰åå…­å¼ å›¾æ¥ç»„æˆå¤©ç©ºç›’ï¼Œä¸€ç§æ˜¯åˆ›å»ºä¸€ä¸ªè¶³å¤Ÿå¤§çš„çƒï¼ŒæŠŠè¿™ä¸ªçƒè¡¨é¢è´´ä¸Šä¸€å¼ å›¾ åœºæ™¯åœ¨çƒé‡Œé¢ç»„æˆå¤©ç©ºçƒã€‚

1. å…­å¼ å›¾ï¼šè¿™ç§æ–¹å¼æ˜¯é€šå…³`three`çš„`THREE.CubeTextureLoader().load`æ–¹æ³•ï¼Œå§å…­å¼ å›¾åœ°å€æ•°æ®æ·»åŠ åˆ°è¯¥å¯¹è±¡é‡Œé¢å»ç„¶åæŠŠåœºæ™¯çš„èƒŒæ™¯è®¾ç½®ä¸ºè¿™ä¸ªå¯¹è±¡ã€‚åŸç†å›¾å¦‚ä¸‹æ‰€ç¤º![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6475292e0b464032a70972d15e0a17f4~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp?)![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/97b2f6557f454e09bb19e7f43c3f6fa8~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp?)
2. ä¸€å¼ å›¾ï¼šå› ä¸º`three`æ²¡æœ‰åŠ è½½`hdr`å¤©ç©ºç›’çš„æ–¹å¼ï¼Œå¯ä»¥æ¨¡ä»¿åŠ è½½å…­å¼ å›¾çš„æ–¹å¼ï¼Œå› ä¸ºåŠ è½½å…­å¼ å›¾ç›¸å½“äºåˆ›å»ºäº†ä¸€ä¸ªæ­£æ–¹ä½“ï¼Œæ¯ä¸ªé¢è´´äº†ä¸€å¼ å›¾ç‰‡æè´¨ï¼Œç›¸æœºåœ¨æ­£æ–¹ä½“å†…å½¢æˆå¤©ç©ºç›’ã€‚é‚£ä¹ˆ`hdr`å•å¼ å›¾å°±å¯ä»¥é€šè¿‡åˆ›å»ºä¸€ä¸ªçƒä½“ï¼Œçƒä½“è¡¨é¢è´´å›¾ï¼Œç›¸æœºåœ¨çƒä½“é‡Œé¢æ¥å®ç°ï¼ˆè¿™ç§æ–¹å¼æ˜¯æˆ‘åŒäº‹æå‡ºæ¥çš„è„‘æ´ğŸ˜‚ï¼‰ã€‚ è¿™é‡Œæ¨èä¸€ä¸ªç½‘å€å¯ä»¥ä¸‹è½½HDRæè´¨ï¼ˆè¿™ä¸ªæè´¨æ—¢å¯ä»¥å½“å¤©ç©ºç›’æ¥ç”¨ï¼Œä¹Ÿå¯ä»¥å½“ç¯å¢ƒè´´å›¾æ¥ç”¨ï¼‰[polyhaven.com/hdris](https://link.juejin.cn/?target=https%3A%2F%2Fpolyhaven.com%2Fhdris) ã€‚

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c1562e4b4e444c009b0ae198732f2477~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp?)

## å¤©ç©ºç›’å®ç°

æˆ‘è¿™é‡Œå¤©ç©ºç›’å®ç°é€‰çš„æ˜¯ç¬¬ä¸€ç§æ–¹å¼ï¼ˆå› ä¸ºæ•°æ®æ˜¯å…­å¼ å›¾çš„ï¼‰ï¼Œä»£ç å¦‚ä¸‹

```javascript
   const textureCube = new THREE.CubeTextureLoader().load(['1.jpg', '2.jpg', '3.jpg', '4.jpg', '5.jpg', '6.jpg'],);
   scene.background = textureCube; // ä½œä¸ºèƒŒæ™¯è´´å›¾
å¤åˆ¶ä»£ç 
```

æ•°æ®å¦‚ä¸‹

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ad61189ddd9f4a7db57ea841b20e3b5d~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp?)

æ•ˆæœ

![SDGIF_Rusult_1.gif](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5e86e7124d6041629c50aa295c059706~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp?)

## æ‰©æ•£åœ†å®ç°æ€è·¯

é€šè¿‡`THREE.RingGeometry`åˆ›å»ºä¸€ä¸ªåœ†,ç„¶åç»™è¿™ä¸ªåœ†æ·»åŠ æƒ³è¦å®ç°æ•ˆæœçš„è´´å›¾ï¼Œç„¶åå†renderå¾ªç¯é‡Œé¢æ¯ä¸€å¸§éƒ½æ”¹å˜è¿™ä¸ªåœ†çš„å¤§å°ã€‚

## æ‰©æ•£åœ†å®ç°

é€šè¿‡åˆ›å»º`THREE.TextureLoader()`æ¥è¿›è¡Œè¯»å–å›¾ç‰‡çº¹ç†æ•°æ®å…¶ä¸­`this.img`ä¸ºå›¾ç‰‡åœ°å€,åˆ›å»º`THREE.RingGeometry`æ¨¡å‹ï¼ŒæŠŠè¯»å‡ºæ¥çš„çº¹ç†èµ‹ç»™`THREE.MeshBasicMaterial`æè´¨ï¼Œç„¶åå†`render`å¾ªç¯é‡Œé¢æ”¹å˜è¿™ä¸ªæ¨¡å‹çš„ç¼©æ”¾æ¯”ä¾‹æ¥è¿›è¡Œæ‰©æ•£æ•ˆæœæ¨¡æ‹Ÿã€‚ ä»£ç å¦‚ä¸‹

```javascript
/* eslint-disable */
import * as THREE from 'three';
/**
 * æ³¢çº¹æ•£å°„å›¾å±‚
 * @param  options.img ç…§ç‰‡åœ°å€
 * @param  options.speed æµåŠ¨é€Ÿåº¦
 * @param  options.scene threeåœºæ™¯
 * @param  options.radius åœ†çš„åŠå¾„
 * @param  options.thing åœ†çš„ä½ç½®
 * @param  options.meshrings å­˜å‚¨åœ†å½¢æ•°æ®
 * @example
 */

class RunRing {
  constructor(option) {
    this.img = option.img || '';
    this.speed = option.speed / 100 || 0.01;
    this.scene = option.scene;
    this.radius = option.radius || 100;
    this.position = option.position || [0, 0, 0];
    this.meshrings = [];
    this.CreatRing();
  }
  CreatRing() {
    //åˆ›å»ºå¯¹è±¡è¯»å–ç…§ç‰‡çº¹ç†
    const textureLoader = new THREE.TextureLoader();
    textureLoader.load(this.img, (texture) => {
      //åˆ›å»ºåœ†åœˆç»“æ„
      const geometry = new THREE.RingGeometry(0, this.radius, 500);
      //åˆ›å»ºæè´¨ æŠŠè¯»å–åˆ°çš„å›¾ç‰‡èµ‹ç»™æè´¨
      const material2 = new THREE.MeshBasicMaterial({
        color: 0xffffff,
        side: THREE.DoubleSide,
        depthTest: true,
        blending: THREE.AdditiveBlending,
        map: texture,
      });
      //ä¼ å…¥çš„å¤šç‚¹çš„è¯ç”Ÿæˆå¤šä¸ªæ¨¡å‹
      for (let i = 0; i < this.position.length; i += 1) {
        //ç»„åˆç”Ÿæˆæ¨¡å‹
        this.meshring = new THREE.Mesh(geometry, material2);
        //è®¾ç½®æ¨¡å‹çš„Xè½´åç§»é‡ï¼Œè®©æ¨¡å‹å¹³é“ºå†Xé¢ä¸Š
        this.meshring.rotateX(Math.PI / 2);
        //è®¾ç½®åˆå§‹çŠ¶æ€æ¨¡å‹ç¼©æ”¾æ¯”ä¾‹
        this.meshring.scale.set(0.1, 0.1, 0.1);
        //è®¾ç½®æ¨¡å‹ä½ç½®
        this.meshring.position.set(this.position[i][0], this.position[i][1], this.position[i][2]);
        //å‚¨å­˜æ¨¡å‹å¯¹è±¡ï¼Œç”¨äºrenderæ”¹å˜å±æ€§å’Œé”€æ¯å¯¹è±¡
        this.meshrings.push(this.meshring)
        //æ·»åŠ åˆ°åœºæ™¯é‡Œé¢
        this.scene.add(this.meshrings[i]);

      }


    });
    //åˆ›å»ºrenderï¼Œæ¯ä¸€å¸§è¿›è¡Œæ¨¡å‹æ”¹å˜
    this.thing = setInterval(() => {
      //å¾ªç¯æ‰€æœ‰åˆ›å»ºçš„æ¨¡å‹ï¼Œè¿›è¡Œæ”¹å˜
      for (let i = 0; i < this.position.length; i += 1) {
        //å¦‚æœæ¨¡å‹å·²ç»åˆ›å»º
        if (this.meshrings[i]) {
          //å½“æ¨¡å‹ç¼©æ”¾æ¯”ä¾‹å°äº1çš„æ—¶å€™ï¼Œæ¨¡å‹è¿›è¡Œæ”¾å¤§
          if (this.meshrings[i].scale.x < 1) {
            this.meshrings[i].scale.set(
              this.meshrings[i].scale.x + 0.01,
              this.meshrings[i].scale.x + 0.01,
              this.meshrings[i].scale.x + 0.01,
            );
          } else {
            //å½“æ¨¡å‹æ¯”ä¾‹å¤§äº1çš„æ—¶å€™ï¼Œæ¨¡å‹é‡ç½®
            this.meshrings[i].scale.set(0.1, 0.1, 0.1);
          }
        }
      }

    }, 50);

  }
  delete() {
    //åˆ é™¤sceneä¸­å¯¹åº”çš„æ¨¡å‹
    for (let i = 0; i < this.position.length; i += 1) {
      if (this.meshrings[i]) {
        this.scene.remove(this.meshrings[i]);
      }
    }
    if (this.thing) {
      //æ¸…é™¤renderäº‹ä»¶
      clearInterval(this.thing);
    }
  }
}
export default RunRing;
å¤åˆ¶ä»£ç 
```

æ•°æ®æ ¼å¼

```javascript
 {
        img: "clice.png",
        scene: scene,
        speed: 1,
        radius: 400,
        position: [
          [400, 30, 400],
          [100, 30, 1200],
        ],
      }
å¤åˆ¶ä»£ç 
```

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a8c509be49684bb89b3048947aa2689e~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp?) æ•ˆæœå›¾

![SDGIF_Rusult_1.gif](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bd34ca5bab8b407f81a5c11d05f90b4a~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp?)

## æ‰©æ•£å¢™å®ç°æ€è·¯

æ‰©æ•£å¢™å’Œä¸Šä¸€èŠ‚ä¸€æ · æ˜¯é€šè¿‡`ShaderMaterial`æ¥å®ç°çš„ï¼Œè¦å®ç°çš„æ•ˆæœæ˜¯å¢™é¢éšç€é«˜åº¦å¢åŠ é€æ˜åº¦ä¹Ÿå¢åŠ ï¼Œæ‰€ä»¥æ¨¡å‹ç‚¹ä½çš„é€æ˜åº¦å’Œé«˜åº¦å‘ˆåæ¯”ã€‚æ¨¡å‹çš„æ‰©æ•£æ•ˆæœæ˜¯æŠŠæ¨¡å‹ç‚¹ä½çš„ä½ç½®é€šè¿‡modå‡½æ•°æ¥è¿›è¡Œå–ä½™è¿ç®—ï¼ˆ%ï¼‰ï¼ŒæŠŠè®¡ç®—ç»“æœé™åˆ¶å†0-1ä¹‹é—´ã€‚

## æ‰©æ•£å¢™å®ç°

```javascript
/* eslint-disable */
import * as THREE from "three";
/**
 * æ³¢åŠ¨å¢™
 * @param  options.scene threeåœºæ™¯
 * @param  options.radius ä¸­å¿ƒ
 * @param  options.height å¢™é«˜åº¦
 * @param  options.opacity å¢™é€æ˜åº¦
 * @param  options.color å¢™é¢œè‰²
 * @example
 */

class Wall {
  constructor(option) {
    this.scene = option.scene;
    this.radius = option.radius || 420;
    this.height = option.height || 120;
    this.opacity = option.opacity || 0.5;
    this.color = option.color || "#efad35";
    this.speed = option.speed || 0.5;
    this.mesh = ""; //ç”Ÿæˆçš„æ¨¡å‹æ•°æ®
    this.CreatRing();
  }
  CreatRing() {
    const vertexShader = `
uniform vec3 u_color;

uniform float time;
uniform float u_height;
 
varying float v_opacity;

void main() {
//æ¨¡å‹ç‚¹ä½ç½®ä¹˜ä»¥ä¸€ä¸ª0.0-1.0çš„ç³»æ•°ï¼Œæ¥æ¨¡æ‹Ÿæ‰©æ•£æ•ˆæœã€‚
    vec3 vPosition = position * mod(time/20.0, 1.0);
//æ¨¡å‹çš„é€æ˜åº¦å’Œæ¨¡å‹çš„é«˜åº¦å‘ˆåæ¯”
    v_opacity =1.0- position.y / u_height;
    gl_Position = projectionMatrix * modelViewMatrix * vec4(vPosition, 1.0);
}
`;
    const fragmentShader = ` 
uniform vec3 u_color;
uniform float u_opacity;
 
varying float v_opacity;

void main() { 
    //u_coloræ˜¯é¢œè‰² v_opacity * u_opacityæ˜¯é«˜åº¦æ‰€äº§ç”Ÿçš„é€æ˜æ•ˆæœå’Œæ¨¡å‹ä¼ å…¥çš„é€æ˜åº¦çš„ä¹˜ç§¯ã€‚
    gl_FragColor = vec4(u_color, v_opacity * u_opacity);
}
`;
//è·å–å‚æ•°
    const { radius, height, opacity, color, speed, renderOrder } = this;
//ç”Ÿæˆæ¨¡å‹ç»“æ„
    const geometry = new THREE.CylinderGeometry(
      radius,
      radius,
      height,
      32,
      1,
      true
    );
    //æ¨¡å‹ä½ç½®è®¾ç½®
    geometry.translate(0, height / 2, 0);
    //è‡ªå®šä¹‰æ¨¡å‹æè´¨
    const material = new THREE.ShaderMaterial({
      uniforms: {
        u_height: {
          value: height,
        },
        u_opacity: {
          value: opacity,
        },
        u_color: {
          value: new THREE.Color(color),
        },
        time: {
          value: 0,
        },
      },
      transparent: true,
      depthWrite: false,
      depthTest: false,
      side: THREE.DoubleSide,
      vertexShader: vertexShader,
      fragmentShader: fragmentShader,
    });
    //ç»„åˆæè´¨å’Œç»“æ„ç”Ÿæˆå¯¹è±¡
    const mesh = new THREE.Mesh(geometry, material);
    //è®¾ç½®æ¨¡å‹é®æŒ¡ï¼ŒæŠŠè¿™ä¸ªæ¨¡å‹æ”¾åˆ°æœ€å‰é¢é˜²æ­¢é®æŒ¡
    mesh.renderOrder = renderOrder || 1;
    this.mesh = mesh;
  }
}

export default Wall;

å¤åˆ¶ä»£ç 
```

æ•ˆæœå›¾

![SDGIF_Rusult_1.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7aeef256bafc44e7a9f24d2dc1b061aa~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp?)

é¡¹ç›®åœ°å€: [github.com/lixiaochjajâ€¦](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Flixiaochjajo%2FSmartCity-Three)

# ä»é›¶å¼€å§‹æ­å»ºå¼€æºæ™ºæ…§åŸå¸‚é¡¹ç›®ï¼ˆå…­ï¼‰é£çº¿ï¼Œé£ç‚¹ã€‚

[![img](https://p9-passport.byteacctimg.com/img/user-avatar/5894006e106aef734beccc90facfcfe1~300x300.image)](https://juejin.cn/user/3703616627815518)

[Lixc ![lv-2](https://lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/f597b88d22ce5370bd94495780459040.svg)](https://juejin.cn/user/3703616627815518)

2021å¹´12æœˆ28æ—¥ 14:17 Â· é˜…è¯» 259

å…³æ³¨

## å‰è¨€

ä¸Šä¸€èŠ‚å®ç°äº†å¤©ç©ºç›’ã€æ‰©æ•£å¢™ã€æ‰©æ•£åœ†ï¼Œè¿™ä¸€èŠ‚æ¥æ·»åŠ é£çº¿ï¼Œé£ç‚¹ã€‚

## æ€è·¯

ä¸»è¦æ€è·¯æ˜¯é€šè¿‡ä¸¤ä¸ªç‚¹å’Œé«˜åº¦åˆ›å»ºè´å¡å°”æ›²çº¿ï¼Œç„¶åæŠŠè¯¥æ›²çº¿çš„ç‚¹æ„é€ æˆ`MeshLine`ï¼ˆè¿™ä¸ªæ’ä»¶å¯ä»¥ç”Ÿæˆæœ‰å®½åº¦çš„çº¿ï¼‰,ç„¶åæŠŠæƒ³è¦æ•ˆæœçš„å›¾è´´åˆ°çº¿ä¸Šã€‚

- é£ç‚¹ï¼š

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/57a47aae6d4f461abdc51a64f2af0f73~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp?)

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/697e4a765e3d448e91c46bdc80e52ae3~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp?)

- é£çº¿

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4aaad45e6f8a40e7b249b1309fea84be~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp?)

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ad639aecd21c4748bfea5ebdd41a799e~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp?)

è¿™é‡Œç”¨åˆ°äº†åˆ«äººå†™çš„`MeshLine`æ’ä»¶ï¼ˆ[github.com/spite/THREEâ€¦](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fspite%2FTHREE.MeshLine) ï¼‰ï¼Œå¯¹è¿™ä¸ªä»£ç åšäº†ä¸€ç‚¹ç‚¹ä¿®æ”¹ï¼Œå¯è¿›è¡Œæ¨¡å‹æè´¨çš„uvç§»åŠ¨ï¼ˆ`THREE`é«˜ç‰ˆæœ¬æœ‰é—®é¢˜ï¼Œæˆ‘è¿™è¾¹ç”¨çš„æ˜¯127ç‰ˆæœ¬æ²¡æœ‰é—®é¢˜ï¼‰ã€‚ ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4d3d1959535e450294a2ed3cb8400158~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp?) è¿™ä¸ªä¿®æ”¹æ˜¯å€Ÿé‰´çš„`deckgl`ï¼ˆ[deck.gl/](https://link.juejin.cn/?target=https%3A%2F%2Fdeck.gl%2F) ï¼‰å…·ä½“çš„ä¿®æ”¹å°±æ˜¯æŠŠ`UV`åç§»é‡ä¼ è¿›å»å®ç°åç§»ã€‚

## ä»£ç 

```javascript
import * as THREE from 'three';
import { Geometry } from 'three/examples/jsm/deprecated/Geometry';
import { MeshLine, MeshLineMaterial } from './THREE.MeshLine';

THREE.Geometry = Geometry;
/**
 * æ³¢çº¹æ•£å°„å›¾å±‚
 * @param  options.img ç…§ç‰‡åœ°å€
 * @param  options.lineWidth çº¿å®½åº¦
 * @param  options.side è´´å›¾æ ·å¼
 * @param  options.camera ç›¸æœº
 * @param  options.height é«˜åº¦
 * @param  options.v0 ç‚¹ä¸€
 * @param  options.v1 ç‚¹äºŒ
 * @param  options.speed æµåŠ¨é€Ÿåº¦
 * @param  options.el èŠ‚ç›®åœºæ™¯å…ƒç´ 
 * @param  options.type çº¿ç±»å‹åˆ†runå’Œtop
 * @param  options.maxheight å½“ç±»å‹ä¸ºtopæ—¶æœ€é«˜ä¸Šå‡é«˜åº¦
 * @param  options.line å­˜å‚¨çº¿
 * @param  options.thing å­˜å‚¨setIntervaläº‹ä»¶
 * @example
 */
class RunLine {
  constructor(option) {
    this.img = option.img || '';
    this.lineWidth = option.lineWidth || 1;
    this.side = option.side || THREE.FrontSide;
    this.camera = option.camera || '';
    this.height = option.height || 100;
    this.v0 = option.v0 || new THREE.Vector3(0, 0, 0);
    this.v1 = option.v1 || new THREE.Vector3(0, 0, 0);
    this.speed = option.speed / 100 || 0.01;
    this.el = option.el || '';
    this.scene = option.scene || '';
    this.type = option.type || 'run';
    this.maxheight = option.maxheight || 300;
    this.line = '';
    this.thing = '';
    this.creatline();
  }

  creatline() {
    const textureLoader = new THREE.TextureLoader();
    textureLoader.load(this.img, (texture) => {
      this.texture = texture;
      this.texture.anisotropy = 16;
      this.texture.wrapS = THREE.RepeatWrapping; // æ¯ä¸ªéƒ½é‡å¤
      this.texture.wrapT = THREE.RepeatWrapping;
      const resolution = new THREE.Vector2(this.el.offsetWidth, this.el.offsetHeight);
      const material1 = new MeshLineMaterial({
        color: '',
        map: this.texture,
        useMap: true,
        lineWidth: this.lineWidth,
        resolution,
        dashArray: 0, // ç ´æŠ˜å·ä¹‹é—´çš„é•¿åº¦å’Œé—´è·ã€‚(0 -æ— ç ´æŠ˜å·)
        dashRatio: 0.7, // å®šä¹‰å¯è§å’Œä¸å¯è§ä¹‹é—´çš„æ¯”ç‡(0 -æ›´å¯è§ï¼Œ1 -æ›´ä¸å¯è§)ã€‚
        dashOffset: 1,
        transparent: true,
        sizeAttenuation: 1, // ä½¿çº¿å®½ä¸å˜ï¼Œä¸ç®¡è·ç¦»(1ä¸ªå•ä½æ˜¯å±å¹•ä¸Šçš„1px)(0 -è¡°å‡ï¼Œ1 -ä¸è¡°å‡)
        side: THREE.FrontSide,
        depthTest: false,
        blending: THREE.AdditiveBlending,
        near: this.camera.near,
        far: this.camera.far,
      });
      this.line = this.createAnimateLine({
        kind: 'sphere', // é»˜è®¤ä¸å¡« ä¸ºæ™®é€š ; å¦‚ä¸ºsphere,åˆ™è¡¨ç¤ºçƒé¢å»ºç‚¹
        type: 'line', // é»˜è®¤ä¸å¡« ä¸ºMeshLine ; å¦‚ä¸ºpipe,åˆ™è¡¨ç¤ºç®¡é“çº¿
        sphereHeightPointsArgs: [this.v0, this.v1],
        material: material1,
        number: 50,
        radius: 3, // é»˜è®¤
      });
      if (this.type === 'run') {
        this.line1 = this.createAnimateLine({
          kind: 'sphere', // é»˜è®¤ä¸å¡« ä¸ºæ™®é€š ; å¦‚ä¸ºsphere,åˆ™è¡¨ç¤ºçƒé¢å»ºç‚¹
          type: 'line', // é»˜è®¤ä¸å¡« ä¸ºMeshLine ; å¦‚ä¸ºpipe,åˆ™è¡¨ç¤ºç®¡é“çº¿
          sphereHeightPointsArgs: [this.v0, this.v1],
          material: material1,
          number: 50,
          radius: 3, // é»˜è®¤
        });
      }

      this.scene.add(this.line);
      this.scene.add(this.line1);
      const { speed } = this;
      if (this.type === 'run') {
        this.thing = setInterval(() => {
          this.line.material.uniforms.offset.value.x -= speed;
          this.line1.material.uniforms.offset.value.x -= speed;
        }, 30);
      } else if (this.type === 'top') {
        this.thing = setInterval(() => {
          if (this.line.position.y < this.maxheight) {
            this.line.position.y += this.speed * 100;
          } else {
            this.line.position.y = 0;
          }
        }, 30);
      }
    });
  }

  createAnimateLine(option) {
    let curve;

    if (option.kind === 'sphere') {
      // ç”±ä¸¤ç‚¹ä¹‹é—´è¿çº¿æˆè´å¡å°”æ›²çº¿
      const { sphereHeightPointsArgs } = option;
      const vX = (sphereHeightPointsArgs[1].x + sphereHeightPointsArgs[0].x) / 2;
      const vZ = (sphereHeightPointsArgs[1].z + sphereHeightPointsArgs[0].z) / 2;
      if (this.type === 'run') {
        curve = new THREE.CubicBezierCurve3(
          sphereHeightPointsArgs[0],
          new THREE.Vector3(vX, this.height, vZ),
          new THREE.Vector3(vX, this.height, vZ),
          sphereHeightPointsArgs[1],
        );
      } else {
        curve = new THREE.CubicBezierCurve3(
          sphereHeightPointsArgs[0],
          new THREE.Vector3(vX, this.height, vZ),
          new THREE.Vector3(vX, this.height, vZ),
          sphereHeightPointsArgs[1],
        );
      }
    }

    if (option.type === 'line') {
      const geo = new THREE.Geometry();
      geo.setFromPoints(curve.getPoints(100));

      // const geo = new Geometry();
      // geo.vertices = option.sphereHeightPointsArgs;
      const meshLine = new MeshLine();
      meshLine.setGeometry(geo);
      return new THREE.Mesh(meshLine.geometry, option.material);
    } // ä½¿ç”¨ meshLine

    return '';
  }

  delete() {
    if (this.line) {
      this.scene.remove(this.line);
      this.scene.remove(this.line1);
    }
    if (this.thing) {
      clearInterval(this.thing);
    }
  }
}

export default RunLine;
å¤åˆ¶ä»£ç 
```

è°ƒç”¨ä»£ç 

```
 this.runline5 = new RunLine({
        img: "n.png",
        camera: camera,
        height: 140,
        v0: new THREE.Vector3(614, 18, 130),
        v1: new THREE.Vector3(-17.5, 111.5, -23),
        el: document.getElementById("scene"),
        scene: scene,
        speed: 1,
        lineWidth: 12,
        type: "run",
      });
å¤åˆ¶ä»£ç 
```

## æ•ˆæœå›¾

![SDGIF_Rusult_1.gif](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/da32bf035b104f7a8576e18e0a79c297~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp?)

é¡¹ç›®åœ°å€[github.com/lixiaochjajâ€¦](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Flixiaochjajo%2FSmartCity-Three)

# ä»é›¶å¼€å§‹æ­å»ºå¼€æºæ™ºæ…§åŸå¸‚é¡¹ç›®ï¼ˆä¸ƒï¼‰åœºæ™¯å¯¼å…¥åˆ°åœ°å›¾ä¸­ã€‚

[![img](https://p9-passport.byteacctimg.com/img/user-avatar/5894006e106aef734beccc90facfcfe1~300x300.image)](https://juejin.cn/user/3703616627815518)

[Lixc ![lv-2](https://lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/f597b88d22ce5370bd94495780459040.svg)](https://juejin.cn/user/3703616627815518)

2022å¹´03æœˆ14æ—¥ 16:00 Â· é˜…è¯» 135

å…³æ³¨

## å‰è¨€

ä¸Šä¸€èŠ‚é€šè¿‡`MeshLine`æ·»åŠ äº†é£çº¿é£ç‚¹ è¿™ä¸€èŠ‚æŠŠæ•´ä¸ªåœºæ™¯å¯¼å…¥åˆ°mapboxä¸­ã€‚

## æ€è·¯

ä¸»è¦æ€è·¯å°±æ˜¯`mapbox`çš„`customLayer`å›¾å±‚ï¼Œå¯ä»¥æŠŠ`three`çš„3dåœºæ™¯é€šè¿‡åœºæ™¯å’Œæ§åˆ¶å™¨çš„é‡å è¿›è¡Œå¯¼å…¥ï¼Œè¿™æ ·æœ¬è´¨ä¸Šmapboxå’Œthreeè¿˜æ˜¯ä¸¤ä¸ªäº’ä¸å¹²æ‰°çš„åœºæ™¯ã€‚

## å®ç°æ­¥éª¤

1. åˆå§‹åŒ–åœ°å›¾åœºæ™¯
2. å½“åœ°å›¾åŠ è½½å®Œæˆåï¼Œåˆå§‹åŒ–customå›¾å±‚ï¼ˆå‚è€ƒ[docs.mapbox.com/mapbox-gl-jâ€¦](https://link.juejin.cn/?target=https%3A%2F%2Fdocs.mapbox.com%2Fmapbox-gl-js%2Fexample%2Fadd-3d-model%2F%3Fsize%3Dn_10_n%EF%BC%89)
3. è®¾ç½®renderä¸­æ¨¡å‹ä½ç½®å’Œç›¸æœºçš„ç›¸å…³å˜åŒ–ï¼ˆæ¶‰åŠåˆ°åæ ‡è½¬æ¢è¿™ä¸ªæ–¹é¢å‡†å¤‡ä¸“é—¨å†™ä¸€ç« æ¥è®²ä¸€ä¸‹è‡ªå·±çš„ç†è§£ï¼‰
4. å…¶ä»–çš„threeç›¸å…³å†…å®¹å‚è€ƒä»¥å‰çš„ç« èŠ‚

## ä»£ç 

```javascript
  initmap() {
      mapboxgl.accessToken =
        "??"; //è¿™é‡Œè¯·æ¢æˆè‡ªå·±çš„token
      map = new mapboxgl.Map({
        container: "map", // container id ç»‘å®šçš„ç»„ä»¶çš„id
        style: "mapbox://styles/mapbox/streets-v11", //åœ°å›¾æ ·å¼ï¼Œå¯ä»¥ä½¿ç”¨å®˜ç½‘é¢„å®šä¹‰çš„æ ·å¼,ä¹Ÿå¯ä»¥è‡ªå®šä¹‰
        center: [121.47, 31.23], // åˆå§‹åæ ‡ç³»
        zoom: 15, // starting zoom åœ°å›¾åˆå§‹çš„æ‹‰ä¼¸æ¯”ä¾‹
        pitch: 60, //åœ°å›¾çš„è§’åº¦ï¼Œä¸å†™é»˜è®¤æ˜¯0ï¼Œå–å€¼æ˜¯0-60åº¦ï¼Œä¸€èˆ¬åœ¨3Dä¸­ä½¿ç”¨
        bearing: -17.6, //åœ°å›¾çš„åˆå§‹æ–¹å‘ï¼Œå€¼æ˜¯åŒ—çš„é€†æ—¶é’ˆåº¦æ•°ï¼Œé»˜è®¤æ˜¯0ï¼Œå³æ˜¯æ­£åŒ—
        antialias: true, //æŠ—é”¯é½¿ï¼Œé€šè¿‡falseå…³é—­æå‡æ€§èƒ½
      });
    }
    setCustomLayer() {
      const customLayer = {
        id: "3d-model",
        type: "custom",
        renderingMode: "3d",
        onAdd: this.initThree,
        // eslint-disable-next-line no-unused-vars
        render: this.threeRender,
      };
      return customLayer;
    },
       initThree(map, gl) {
      //åˆ›å»ºåœºæ™¯
      scene = new THREE.Scene();
      /**
       * é€è§†æŠ•å½±ç›¸æœºè®¾ç½®
       */
      const width = window.innerWidth; // çª—å£å®½åº¦
      const height = window.innerHeight; // çª—å£é«˜åº¦

      /** é€è§†æŠ•å½±ç›¸æœºå¯¹è±¡ */
      camera = new THREE.PerspectiveCamera(60, width / height, 1, 700);
      camera.position.set(600, 900, 600); // æ ‘ä¸Šé¢è§‚å¯Ÿ
      camera.lookAt(scene.position); // è®¾ç½®ç›¸æœºæ–¹å‘(æŒ‡å‘çš„åœºæ™¯å¯¹è±¡)
      // åˆ›å»ºæ¸²æŸ“å™¨å¯¹è±¡
      //   const container = document.getElementById("scene");
      renderer = new THREE.WebGLRenderer({
        canvas: map.getCanvas(),
        context: gl,
        antialias: true,
      });
      //   container.appendChild(renderer.domElement); // bodyå…ƒç´ ä¸­æ’å…¥canvaså¯¹è±¡

      //åˆ›å»ºç‚¹å…‰æºå’Œç¯å¢ƒå…‰æº
      const point = new THREE.PointLight(0xffffff);
      point.position.set(600, 900, 600); // ç‚¹å…‰æºä½ç½®
      scene.add(point); // ç‚¹å…‰æºæ·»åŠ åˆ°åœºæ™¯ä¸­
      // ç¯å¢ƒå…‰
      const ambient = new THREE.AmbientLight(0x404040, 1);
      scene.add(ambient);
      renderer.autoClear = false;
      //   pickingScene = new THREE.Scene(); //ç¦»å±æ¸²æŸ“
      //   pickingTexture = new THREE.WebGLRenderTarget(1, 1); //ç¦»å±æ¸²æŸ“
    },
    threeRender(gl, matrix) {
      const modelOrigin = [121.47, 31.23];
      const modelAltitude = 770;
      const modelRotate = [Math.PI / 4, 0, 0];
      const modelAsMercatorCoordinate = mapboxgl.MercatorCoordinate.fromLngLat(
        modelOrigin,
        modelAltitude
      );
      const modelTransform = {
        translateX: modelAsMercatorCoordinate.x,
        translateY: modelAsMercatorCoordinate.y,
        translateZ: modelAsMercatorCoordinate.z,
        rotateX: modelRotate[0],
        rotateY: modelRotate[1],
        rotateZ: modelRotate[2],
        scale: modelAsMercatorCoordinate.meterInMercatorCoordinateUnits(),
      };
      const rotationX = new THREE.Matrix4().makeRotationAxis(
        new THREE.Vector3(1, 0, 0),
        modelTransform.rotateX
      );
      const rotationY = new THREE.Matrix4().makeRotationAxis(
        new THREE.Vector3(0, 1, 0),
        modelTransform.rotateY
      );
      const rotationZ = new THREE.Matrix4().makeRotationAxis(
        new THREE.Vector3(0, 0, 1),
        modelTransform.rotateZ
      );

      const m = new THREE.Matrix4().fromArray(matrix);
      const l = new THREE.Matrix4()
        .makeTranslation(
          modelTransform.translateX,
          modelTransform.translateY,
          modelTransform.translateZ
        )
        .scale(
          new THREE.Vector3(
            modelTransform.scale,
            -modelTransform.scale,
            modelTransform.scale
          )
        )
        .multiply(rotationX)
        .multiply(rotationY)
        .multiply(rotationZ);

      camera.projectionMatrix = m.multiply(l);
      this.cityanimate();
      renderer.resetState();
      renderer.render(scene, camera);
      map.triggerRepaint();
    },
å¤åˆ¶ä»£ç 
```

è°ƒç”¨ä»£ç 

```
this.initmap();
    map.on("style.load", () => {
      let customLayer = this.setCustomLayer();
      map.addLayer(customLayer, "waterway-label");
      this.addGLTF();
      this.creatWall();
      this.creatRunLine();
    });
å¤åˆ¶ä»£ç 
```

## æ•ˆæœå›¾

![SDGIF_Rusult_1.gif](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/328485d3f6f5473ab45263d29cbf042c~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp?)

é¡¹ç›®åœ°å€[github.com/lixiaochjajâ€¦](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Flixiaochjajo%2FSmartCity-Three)